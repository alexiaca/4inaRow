/*
* grrd's 4 in a Row
* Copyright (c) 2012 Gerard Tyedmers, grrd@gmx.net
* Licensed under the MPL License
*/
"use strict";!function(){function a(a,b,c,d){F[b].beginPath(),F[b].arc(Z/2,a,Z/2*.85,0,2*Math.PI,!1),F[b].fillStyle=c,F[b].fill(),F[b].lineWidth=Z/20,F[b].strokeStyle=d,F[b].stroke()}function b(){ha="2player",ja?($("#P1icon").attr("src",la.attr("src")),$("#P1icon2").attr("src",la.attr("src"))):($("#P1icon").attr("src","Images/player.png"),$("#P1icon2").attr("src","Images/player.png")),N=ka?ma.val():navigator.mozL10n.get("lbplayer1"),O=navigator.mozL10n.get("lbplayer2"),$("#P1name").html(N),$("#P1name2").html(N),$("#P2name").html(O),$("#P2name2").html(O),$("#P2icon").attr("src","Images/player.png"),$("#P2icon2").attr("src","Images/player.png"),j(),Da=!1,$.mobile.changePage("#game",{transition:"slide"})}function c(){$.mobile.changePage("#popupOnline",{transition:"pop",role:"dialog"}),$("#btonline").addClass("ui-disabled"),$("#btonline2").addClass("ui-disabled"),Aa?aa.socket.reconnect():(aa=io.connect("http://grrds4inarow.nodejitsu.com:80"),Aa=!0),aa.on("connect",function(a){}),aa.on("startgame",function(a){ba=a,ba.id!=ca&&(M=ja?la.attr("src"):null,aa.emit("usersend",{to:ba.opponent,name:ma.val(),pic:M,country:0,points:0,rank:0}),ca=ba.id,Da=!1,null!==ha&&$.mobile.changePage("#title",{transition:"slide",reverse:!0}),C=!1,w(),xa=0,ua=0,ya=[0,0],j(),ha="online",0==ba.role?(ja?($("#P1icon").attr("src",la.attr("src")),$("#P1icon2").attr("src",la.attr("src"))):($("#P1icon").attr("src","Images/player.png"),$("#P1icon2").attr("src","Images/player.png")),N=ka?ma.val():navigator.mozL10n.get("lbplayer1"),$("#P2icon").attr("src","Images/online.png"),$("#P2icon2").attr("src","Images/online.png"),O=navigator.mozL10n.get("btonline")):($("#P1icon").attr("src","Images/online.png"),$("#P1icon2").attr("src","Images/online.png"),N=navigator.mozL10n.get("btonline"),ja?($("#P2icon").attr("src",la.attr("src")),$("#P2icon2").attr("src",la.attr("src"))):($("#P2icon").attr("src","Images/player.png"),$("#P2icon2").attr("src","Images/player.png")),O=ka?ma.val():navigator.mozL10n.get("lbplayer1")),$("#P1name").html(N),$("#P1name2").html(N),$("#P2name").html(O),$("#P2name2").html(O),$.mobile.changePage("#game",{transition:"slide"}))}),aa.on("playget",function(a){Ca==a.round&&Ba!=a.round&&(Ba=a.round,Ea=!0,m(a.col))}),aa.on("userget",function(a){0==ba.role?(null!==a.pic&&($("#P2icon").attr("src",a.pic),$("#P2icon2").attr("src",a.pic)),a.name.length>0&&(O=a.name,$("#P2name").html(O),$("#P2name2").html(O))):(null!==a.pic&&($("#P1icon").attr("src",a.pic),$("#P1icon2").attr("src",a.pic)),a.name.length>0&&(N=a.name,$("#P1name").html(N),$("#P1name2").html(N)))}),aa.on("quit",function(){ba.id!=da&&(da=ba.id,Da=!0,$.mobile.changePage("#popupLeft",{transition:"pop",role:"dialog"}))})}function d(){ha="easy",g()}function e(){ha="medium",g()}function f(){ha="hard",g()}function g(){ja?($("#P1icon").attr("src",la.attr("src")),$("#P1icon2").attr("src",la.attr("src"))):($("#P1icon").attr("src","Images/player.png"),$("#P1icon2").attr("src","Images/player.png")),N=ka?ma.val():navigator.mozL10n.get("lbplayer"),O=navigator.mozL10n.get("lbcomputer"),$("#P1name").html(N),$("#P1name2").html(N),$("#P2name").html(O),$("#P2name2").html(O),$("#P2icon").attr("src","Images/computer.png"),$("#P2icon2").attr("src","Images/computer.png"),j(),Da=!1,$.mobile.changePage("#game",{transition:"slide"})}function h(){"online"==ha&&(aa.disconnect(),$("#btonline").removeClass("ui-disabled"),$("#btonline2").removeClass("ui-disabled")),Da=!0,x(),$.mobile.changePage("#title",{transition:"slide",reverse:!0}),C=!1,w(),xa=0,ua=0,ya=[0,0],ha=null}function i(){ia="on"===oa.val(),localStorage.setItem("s_sound",oa.val()),x(),$.mobile.changePage("#title",{transition:"pop",reverse:!0})}function j(){$("#P1light").attr("src",va[ua]),$("#P2light").attr("src",wa[1-ua]),$("#P1light2").attr("src",va[ua]),$("#P2light2").attr("src",wa[1-ua])}function k(b,c,d){if(C){var e=new Date,f=e.getTime(),g=f-b,h=_*g/1e3;X>c?(c=Math.min(X,c+h),b=f,F[d].clearRect(0,0,Z,X+Z/2*.85),a(c,d,ra[ua],sa[ua]),requestAnimFrame(function(){k(b,c,d)})):(ia&&document.getElementById("click_sound").play(),C=!1,n(ua,!0),U?(ya[ua]=ya[ua]+1,ia&&document.getElementById("ding_sound").play(),0==ua?u(N+" "+navigator.mozL10n.get("lbwin"),(new Date).getTime()):u(O+" "+navigator.mozL10n.get("lbwin"),(new Date).getTime())):V?(ua=1-ua,j(),"2player"!=ha&&"online"!=ha&&1==ua&&p()):u(navigator.mozL10n.get("lbdraw"),(new Date).getTime()))}}function l(a){"online"==ha?1==ua&&0==ba.role||0==ua&&1==ba.role||(aa.emit("playsend",{to:ba.opponent,col:a,round:Ca}),m(a)):m(a)}function m(a){if(!(Ea&&(Ea=!1,"online"==ha&&(0==ua&&0==ba.role||1==ua&&1==ba.role))||C))for(Ca+=1,R=0,X=0;R<G.length&&0===X;){if(void 0==G[R][a]){C=!0,G[R][a]=ua,X=(G.length-R-.5)*Z*.85;var b=new Date,c=b.getTime();Y=-30,k(c,Y,a);break}R+=1}}function n(a,b){for(U=!1,R=0;R<G.length;++R)for(Q=0;Q<G[R].length;++Q)o(R,Q,1,0,a,b),o(R,Q,0,1,a,b),o(R,Q,1,1,a,b),o(R,Q,1,-1,a,b);for(V=!1,Q=0;Q<G[0].length;++Q)void 0==G[G.length-1][Q]&&(V=!0)}function o(a,b,c,d,e,f){if(a+3*c<G.length&&b+3*d<G[a].length&&a+3*c>=0&&b+3*d>=0)for(var g=0;4>g;++g)G[a+g*c][b+g*d]==e?(ea[g]=a+g*c,fa[g]=b+g*d,ga[g]=e,3==g&&(U=!0,f&&s(),g=5)):g=5}function p(){for(pa=[],W=!1,S=0;S<G[0].length;++S)for(pa[S]=0,T=0;T<G.length;++T)if(void 0==G[T][S]){G[T][S]=ua,r(ua,T,S),pa[S]=1e4*K+100*I+J+2,G[T][S]=void 0;break}qa[0]=0;for(var a=0;a<pa.length;++a)pa[a]>qa[0]&&(qa[0]=pa[a]);for(ua=1-ua,S=0;S<G[0].length;++S)for(T=0;T<G.length;++T)if(void 0==G[T][S]){G[T][S]=ua,r(ua,T,S),1e4*K+100*I+J+2>qa[0]&&(pa[S]=1e4*K+100*I+J+2),G[T][S]=void 0;break}for(ua=1-ua,ua=1-ua,S=0;S<G[0].length;++S){for(T=0;T<G.length-1;++T)if(void 0==G[T][S]){G[T+1][S]=ua,n(ua,W),G[T+1][S]=void 0;break}U&&(pa[S]=1,U=!1)}for(ua=1-ua,ua=1-ua,S=0;S<G[0].length;++S){for(T=0;T<G.length;++T)if(void 0==G[T][S]){G[T][S]=ua,n(ua,W),G[T][S]=void 0;break}U&&(pa[S]=5e4,U=!1)}for(ua=1-ua,S=0;S<G[0].length;++S){for(T=0;T<G.length;++T)if(void 0==G[T][S]){G[T][S]=ua,n(ua,W),G[T][S]=void 0;break}U&&(pa[S]=6e4,U=!1)}if(qa=pa.slice(),qa.sort(q),qa.reverse(),Q=Math.round(6*Math.random()),"hard"==ha)for(;pa[Q]!=qa[0];)Q=Math.round(6*Math.random());if("medium"==ha)for(;pa[Q]<qa[1]||0===pa[Q];)Q=Math.round(6*Math.random());if("easy"==ha)for(;pa[Q]<qa[2]||0===pa[Q];)Q=Math.round(6*Math.random());m(Q)}function q(a,b){return a-b}function r(a,b,c){I=0,J=0,K=0;for(var d=c-3;c>=d;++d)if(d>=0&&d+3<G[0].length){za=!0,L=0;for(var e=0;3>=e;++e)void 0!==G[b][d+e]&&(G[b][d+e]==a?L+=1:za=!1);za&&(I+=1,J+=L,L>K&&(K=L))}for(d=b+3;d>=b;--d)if(d-3>=0&&d<G.length){for(za=!0,L=0,e=0;3>=e;++e)void 0!==G[d-e][c]&&(G[d-e][c]==a?L+=1:za=!1);za&&(I+=1,J+=L,L>K&&(K=L))}for(d=3;d>=0;--d)if(c-d>=0&&c-d+3<G[0].length&&b-d>=0&&b-d+3<G.length){for(za=!0,L=0,e=0;3>=e;++e)void 0!==G[b-d+e][c-d+e]&&(G[b-d+e][c-d+e]==a?L+=1:za=!1);za&&(I+=1,J+=L,L>K&&(K=L))}for(d=3;d>=0;--d)if(c-d>=0&&c-d+3<G[0].length&&b+d<G.length&&b+d-3>=0){for(za=!0,L=0,e=0;3>=e;++e)void 0!==G[b+d-e][c-d+e]&&(G[b+d-e][c-d+e]==a?L+=1:za=!1);za&&(I+=1,J+=L,L>K&&(K=L))}}function s(){C=!0;var a=ea.slice(),b=fa.slice();t(a,b,0,(new Date).getTime())}function t(b,c,d,e){if(!Da)if(6>d&&e+250<(new Date).getTime()&&C){++d,e=(new Date).getTime();for(var f=0;4>f;++f)d%2!==0?a((G.length-b[f]-.5)*Z*.85,c[f],ta[ua],"white"):a((G.length-b[f]-.5)*Z*.85,c[f],ra[ua],"white");requestAnimFrame(function(){t(b,c,d,e)})}else 6>d&&C&&requestAnimFrame(function(){t(b,c,d,e)})}function u(a,b){Da||(b+2e3>(new Date).getTime()&&C?requestAnimFrame(function(){u(a,b)}):(xa+=1,$("#printMessage").html(a),1==xa?$("#printSpiele").html(xa+" "+navigator.mozL10n.get("lbgame")):$("#printSpiele").html(xa+" "+navigator.mozL10n.get("lbgames")),$("#printScore1a").html(N),$("#printScore2a").html(O),$("#printScore1b").html(ya[0]),$("#printScore2b").html(ya[1]),$.mobile.changePage("#popupDialog",{transition:"pop",role:"dialog"}),w(),ua=xa%2!==0?1:0,j(),C=!1))}function v(){$.mobile.changePage("#game",{transition:"pop",reverse:!0}),"2player"!=ha&&"online"!=ha&&1==ua&&p()}function w(){Ca=0,Ba=null;for(var a=0;a<G.length;++a)for(var b=0;b<G[a].length;++b)G[a][b]=void 0,0===a&&F[b].clearRect(0,0,Z,_);x()}function x(){var b=$(window).height(),c=$(window).width();b>c?(Z=Math.min((c-50)/7,(b-140)/6),_=Math.max(6*Z*.85,b-190),na.attr("style","width:100%;"),$("#listheight1").attr("style","height:"+($(window).height()-$(window).width()/3-130)/7+"px;"),$("#listheight2").attr("style","height:"+($(window).height()-$(window).width()/3-130)/7+"px;"),$("#listheight3").attr("style","height:"+($(window).height()-$(window).width()/3-130)/7+"px;"),$("#listheight4").attr("style","height:"+($(window).height()-$(window).width()/3-130)/7+"px;"),$("#listheight5").attr("style","height:"+($(window).height()-$(window).width()/3-130)/7+"px;"),$("#listpadd1").attr("style","padding-top:"+($(window).height()-$(window).width()/3-270)/14+"px;"),$("#listpadd2").attr("style","padding-top:"+($(window).height()-$(window).width()/3-270)/14+"px;"),$("#listpadd3").attr("style","padding-top:"+($(window).height()-$(window).width()/3-270)/14+"px;"),$("#listpadd4").attr("style","padding-top:"+($(window).height()-$(window).width()/3-270)/14+"px;"),$("#listpadd5").attr("style","padding-top:"+($(window).height()-$(window).width()/3-270)/14+"px;"),$("#page_landscape").attr("style","display:none;"),$("#page_portrait").attr("style","display:inline;"),$("#indicator_landscape_l").attr("style","display:none;"),$("#indicator_landscape_r").attr("style","display:none;"),$("#indicator_portrait").attr("style","display:block;"),$("#popupDialog_landscape").attr("style","display:none;"),$("#popupDialog_portrait").attr("style","display:block;"),$("#popupSettings_portrait").attr("style","display:block;"),$("#popupSettings_landscape").attr("style","display:none;"),$("#popupSettings_col_b").appendTo("#popupSettings_portrait"),$("#printMessage").attr("style","display:block;")):(Z=Math.min((c-140-40)/7,(b-20)/6),_=Math.max(6*Z*.85,b-95),na.attr("style","width:"+.6*$(window).width()+"px;"),$("#blankspace").attr("style","height:"+($(window).height()/4-$(window).width()/20)+"px;"),$("#page_landscape").attr("style","display:inline;"),$("#page_portrait").attr("style","display:none;"),$("#indicator_landscape_l").attr("style","display:inline;"),$("#indicator_landscape_r").attr("style","display:inline;"),$("#indicator_portrait").attr("style","display:none;"),$("#popupDialog_landscape").attr("style","display:block;"),$("#popupDialog_portrait").attr("style","display:none;"),$("#popupSettings_portrait").attr("style","display:none;"),$("#popupSettings_landscape").attr("style","display:block;"),$("#popupSettings_col_b").appendTo("#popupSettings_landscape_b"),$("#printMessage").attr("style","display:inline;"));var d=Math.max((b-c/3)/7,0);$("#btplay").attr("style","width:"+(c/5-8)+"px;padding-bottom:"+d/2+"px;"),$("#btonline").attr("style","width:"+(c/5-8)+"px;padding-bottom:"+d/2+"px;"),$("#bteasy").attr("style","width:"+(c/5-8)+"px;padding-bottom:"+d/2+"px;"),$("#btmed").attr("style","width:"+(c/5-8)+"px;padding-bottom:"+d/2+"px;"),$("#bthard").attr("style","width:"+(c/5-8)+"px;padding-bottom:"+d/2+"px;"),$("#imgplay").attr("style","padding-top:"+d+"px;padding-bottom:"+d/2+"px;width: 100%;min-width: 40px;max-width: 108px;"),$("#imgonline").attr("style","padding-top:"+d+"px;padding-bottom:"+d/2+"px;width: 100%;min-width: 40px;max-width: 108px;"),$("#imgeasy").attr("style","padding-top:"+d+"px;padding-bottom:"+d/2+"px;width: 100%;min-width: 40px;max-width: 108px;"),$("#imgmed").attr("style","padding-top:"+d+"px;padding-bottom:"+d/2+"px;width: 100%;min-width: 40px;max-width: 108px;"),$("#imghard").attr("style","padding-top:"+d+"px;padding-bottom:"+d/2+"px;width: 100%;min-width: 40px;max-width: 108px;");for(var e=0;e<D.length;++e)document.getElementById(D[e]).width=Z,document.getElementById(D[e]).height=_;for(var f=0;f<G[0].length&&"undefined"!=typeof F[f];++f)for(e=0;e<G.length;++e)F[f].beginPath(),F[f].arc(Z/2,(G.length-e-.5)*Z*.85,Z/2*.7,0,2*Math.PI,!1),F[f].lineWidth=Z/10,F[f].strokeStyle="#212121",F[f].stroke(),F[f].beginPath(),F[f].arc(Z/2,(G.length-e-.5)*Z*.85,Z/2*.7,1.8*Math.PI,.8*Math.PI,!1),F[f].lineWidth=E[f].width/10,F[f].strokeStyle="grey",F[f].stroke();for(f=0;f<G[0].length&&"undefined"!=typeof F[f];++f){for(F[f].save(),F[f].beginPath(),e=0;e<G.length;++e)F[f].arc(Z/2,(G.length-e-.5)*Z*.85,Z/2*.7,0,2*Math.PI,!1);F[f].clip(),F[f].clearRect(0,0,Z,_)}for(e=0;e<G.length;++e)for(f=0;f<G[e].length;++f)void 0!=G[e][f]&&a((G.length-e-.5)*Z*.85,f,ra[G[e][f]],sa[G[e][f]]);C&&(Y=Y/X*(G.length-R-.5)*Z*.85,X=(G.length-R-.5)*Z*.85)}function y(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.href);return null!==d?d[1]:!1}function z(a){""!==a.replace(/\s+/g,"")?(localStorage.setItem("s_name",a),ka=!0):(localStorage.removeItem("s_name"),ka=!1)}function A(){$("#b_imageinput").click()}function B(a){var b,c=new FileReader,d=document.createElement("canvas"),e=null,f=new Image,g=67,h=71;d.id="hiddenCanvas",d.width=g,d.height=h,d.style.visibility="hidden",document.body.appendChild(d),e=d.getContext("2d"),a.target.files[0].type.match("image.*")?c.readAsDataURL(a.target.files[0]):alert("File is not an image"),c.onload=function(){var a=this.result;b=EXIF.readFromBinaryFile(new BinaryFile(atob(a.split(",")[1]))),f.src=a},f.onload=function(){var a=0,c=0;0===this.width||0===this.height?alert("Image is empty"):((5===b.Orientation||6===b.Orientation)&&(e.rotate(90*Math.PI/180),c=-1*g,g=71,h=67),(3===b.Orientation||4===b.Orientation)&&(e.rotate(180*Math.PI/180),c=-1*g-4,a=-1*h+4),(7===b.Orientation||8===b.Orientation)&&(e.rotate(270*Math.PI/180),a=-1*h,g=71,h=67),e.clearRect(0,0,g,h),e.drawImage(f,0,0,this.width,this.height,a,c,g,h),la.attr("src",d.toDataURL("image/jpeg")),$("#inputImage_l").attr("src",d.toDataURL("image/jpeg")),localStorage.setItem("s_image",d.toDataURL("image/jpeg")),ja=!0)}}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();for(var C=!1,D=["spalte0","spalte1","spalte2","spalte3","spalte4","spalte5","spalte6"],E=new Array(6),F=new Array(6),G=new Array(6),H=0;H<G.length;++H)G[H]=new Array(7);var I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea=new Array(4),fa=new Array(4),ga=new Array(4),ha=null,ia=!0,ja=!1,ka=!1,la=$("#inputImage"),ma=$("#inputName"),na=$("#img_title"),oa=$("#b_sound"),pa=new Array(7),qa=new Array(3),ra=["#ff0080","#6969EE"],sa=["#D6016B","#5A5ACE"],ta=["#FD6BB4","#9393EF"],ua=0,va=["Images/lightredon.png","Images/lightredoff.png"],wa=["Images/lightblueon.png","Images/lightblueoff.png"],xa=0,ya=[0,0],za=Boolean(!1),Aa=!1,Ba=null,Ca=0,Da=!1,Ea=!1;window.onload=function(){null===localStorage.getItem("s_sound")?oa.val("on"):oa.val(localStorage.getItem("s_sound")),ia="on"===oa.val(),null!==localStorage.getItem("s_image")&&(la.attr("src",localStorage.getItem("s_image")),$("#inputImage_l").attr("src",localStorage.getItem("s_image")),ja=!0),null!==localStorage.getItem("s_name")&&(ma.val(localStorage.getItem("s_name")),""!==localStorage.getItem("s_name").replace(/\s+/g,"")&&(ka=!0)),P=y("theme"),P&&"mi"==P&&(na.attr("src","Images/title1_mi.png"),$("#popupDialog_t1").attr("src","Images/title1_mi.png"),$("#popupDialog_t2").attr("src","Images/title2_mi.png"),$("#popupInfo_t1").attr("src","Images/title1_mi.png"),$("#popupInfo_t2").attr("src","Images/title2_mi.png"),$("#popupSettings_t1").attr("src","Images/title1_mi.png"),$("#popupSettings_t2").attr("src","Images/title2_mi.png")),$('[id^="btplay"]').click(function(a){b(),a.preventDefault()}),$('[id^="btonline"]').click(function(a){c(),a.preventDefault()}),$('[id^="bteasy"]').click(function(a){d(),a.preventDefault()}),$('[id^="btmed"]').click(function(a){e(),a.preventDefault()}),$('[id^="bthard"]').click(function(a){f(),a.preventDefault()}),$(".back").click(function(a){h(),a.preventDefault()}),$(".again").click(function(a){v(),a.preventDefault()}),$(".btimg").click(function(a){A(),a.preventDefault()}),$(".btclose").click(function(a){i(),a.preventDefault()}),$("#inputName").change(function(){z(this.value)});for(var a=0;a<D.length;++a)E[a]=document.getElementById(D[a]),F[a]=E[a].getContext("2d");document.getElementById("spalte0").addEventListener("click",function(){l(0)}),document.getElementById("spalte1").addEventListener("click",function(){l(1)}),document.getElementById("spalte2").addEventListener("click",function(){l(2)}),document.getElementById("spalte3").addEventListener("click",function(){l(3)}),document.getElementById("spalte4").addEventListener("click",function(){l(4)}),document.getElementById("spalte5").addEventListener("click",function(){l(5)}),document.getElementById("spalte6").addEventListener("click",function(){l(6)}),jQuery.preLoadImages("Images/lightredon.png","Images/lightredoff.png","Images/lightblueon.png","Images/lightblueoff.png","Images/title2eng.png"),document.getElementById("b_imageinput").addEventListener("change",B,!1),$("#popupSettings_col_b").find("label").attr("style","display:inline;"),x(),na.delay(1500),na.fadeOut(1e3),na.queue(function(){P=y("theme"),P&&"mi"==P?na.attr("src","Images/title2_mi.png"):na.attr("src","Images/title2eng.png"),$(this).fadeIn(1e3),$(this).dequeue()})},$(window).resize(function(){x()}),function(a){var b=[];a.preLoadImages=function(){for(var a=arguments.length,c=a;c--;){var d=document.createElement("img");d.src=arguments[c],b.push(d)}}}(jQuery),navigator.mozL10n.ready(function(){P=y("lang"),P&&P!==navigator.mozL10n.language.code&&(navigator.mozL10n.language.code=P)})}();